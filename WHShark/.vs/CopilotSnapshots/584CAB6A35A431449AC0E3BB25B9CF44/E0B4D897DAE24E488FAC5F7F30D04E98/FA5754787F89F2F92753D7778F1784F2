using Services.DomainModel.Exceptions;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace Services.DAL.Implementations
{
    internal sealed class LanguageRepository
    {
        #region Singleton
        private readonly static LanguageRepository _instance = new LanguageRepository();

        public static LanguageRepository Current
        {
            get
            {
                return _instance;
            }
        }

        private LanguageRepository()
        {
            //Implement here the initialization code
        }
        #endregion

        private string basePath = ConfigurationManager.AppSettings["LanguagePath"];

        public string Find(string word)
        {
            string filePath = basePath + "." + Thread.CurrentThread.CurrentCulture.Name;

            if (!File.Exists(filePath))
                throw new WordNotFoundException();

            using (var sr = new StreamReader(filePath))
            {
                while (!sr.EndOfStream)
                {
                    string lineText = sr.ReadLine();
                    if (String.IsNullOrWhiteSpace(lineText))
                        continue;

                    string[] line = lineText.Split(new[] { '=' }, 2);

                    if (line.Length >= 1 && line[0] == word)
                    //Encontré la clave buscada...
                    {
                        if (line.Length == 1 || String.IsNullOrEmpty(line[1]))
                            //Aplicar una bitácora...
                            return line[0];

                        return line[1];//Retorno la traducción...
                    }
                }
            }

            throw new WordNotFoundException();
        }

        public void WriteNewWord(string word, string value)
        {
            // Escribe la nueva clave en todos los archivos de idiomas existentes.
            var cultures = GetCurrentCultures();

            foreach (var culture in cultures)
            {
                string filePath = basePath + "." + culture;

                try
                {
                    // Asegurar que el directorio existe
                    var dir = Path.GetDirectoryName(filePath);
                    if (!String.IsNullOrEmpty(dir) && !Directory.Exists(dir))
                        Directory.CreateDirectory(dir);

                    // Si el archivo no existe, crearlo
                    if (!File.Exists(filePath))
                    {
                        using (var sw = new StreamWriter(filePath, false, Encoding.UTF8))
                        {
                            sw.WriteLine($"{word}={value}");
                        }
                    }
                    else
                    {
                        // Si ya existe, comprobar si la clave ya está presente
                        bool exists = false;
                        var lines = File.ReadAllLines(filePath);
                        for (int i = 0; i < lines.Length; i++)
                        {
                            var parts = lines[i].Split(new[] { '=' }, 2);
                            if (parts.Length >= 1 && parts[0] == word)
                            {
                                exists = true;
                                // Si se pasó un valor, actualizar; si no, dejar como está
                                if (!String.IsNullOrEmpty(value))
                                    lines[i] = $"{word}={value}";
                                break;
                            }
                        }

                        if (!exists)
                        {
                            using (var sw = new StreamWriter(filePath, true, Encoding.UTF8))
                            {
                                sw.WriteLine($"{word}={value}");
                            }
                        }
                        else
                        {
                            // Si existía y fue actualizado, sobrescribir el archivo
                            File.WriteAllLines(filePath, lines, Encoding.UTF8);
                        }
                    }
                }
                catch
                {
                    // Ignorar errores de escritura de idioma para no interrumpir la operación principal
                }
            }
        }

        public Dictionary<string, string> FindAll()
        {
            var result = new Dictionary<string, string>();
            string filePath = basePath + "." + Thread.CurrentThread.CurrentCulture.Name;

            if (!File.Exists(filePath))
                return result;

            using (var sr = new StreamReader(filePath))
            {
                while (!sr.EndOfStream)
                {
                    string lineText = sr.ReadLine();
                    if (String.IsNullOrWhiteSpace(lineText))
                        continue;

                    string[] line = lineText.Split(new[] { '=' }, 2);
                    if (line.Length >= 1)
                    {
                        string key = line[0];
                        string val = line.Length == 2 ? line[1] : String.Empty;

                        if (!result.ContainsKey(key))
                            result.Add(key, val);
                    }
                }
            }

            return result;
        }

        /// <summary>
        /// Generar una implementación que lea las extensiones de todos mis archivos dentro de I18n
        /// </summary>
        /// <returns></returns>
        public List<string> GetCurrentCultures()
        {
            var result = new List<string>();

            try
            {
                var dir = Path.GetDirectoryName(basePath);
                var fileName = Path.GetFileName(basePath);

                if (String.IsNullOrEmpty(dir))
                {
                    dir = AppDomain.CurrentDomain.BaseDirectory;
                }

                if (!Directory.Exists(dir))
                    return result;

                // Buscar archivos que empiecen con el base filename seguido de '.' y la cultura
                var files = Directory.GetFiles(dir, fileName + ".*");

                foreach (var f in files)
                {
                    var ext = Path.GetExtension(f);
                    if (ext.StartsWith("."))
                        ext = ext.Substring(1);

                    if (!String.IsNullOrEmpty(ext) && !result.Contains(ext))
                        result.Add(ext);
                }
            }
            catch
            {
                // ignorar
            }

            return result;
        }
    }
}
